<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #e07fa9;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        button {
            background: #e07fa9;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        pre {
            background: #f8f8f8;
            padding: 10px;
            overflow: auto;
            border-radius: 4px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Invoice Generator Diagnostics</h1>
    
    <div class="card">
        <h2>Basic Checks</h2>
        <div id="basic-checks"></div>
    </div>

    <div class="card">
        <h2>Library Tests</h2>
        <div id="lib-tests"></div>
    </div>

    <div class="card">
        <h2>LocalStorage Test</h2>
        <div id="storage-test"></div>
        <button onclick="testStorage()">Test LocalStorage</button>
        <button onclick="resetStorage()">Reset LocalStorage</button>
    </div>

    <div class="card">
        <h2>Quick Actions</h2>
        <button onclick="autoLogin()">Auto Login</button>
        <button onclick="clearLogin()">Clear Login</button>
        <button onclick="window.location.href='index.html'">Go to App</button>
        <button onclick="window.location.href='login.html'">Go to Login</button>
    </div>

    <script>
        // Basic diagnostics
        function runBasicChecks() {
            const checks = document.getElementById('basic-checks');
            
            // JavaScript enabled - obviously true if this runs
            checks.innerHTML += `<p class="success">✓ JavaScript enabled</p>`;
            
            // Browser information
            checks.innerHTML += `<p>Browser: ${navigator.userAgent}</p>`;
            
            // Cookie enabled
            if (navigator.cookieEnabled) {
                checks.innerHTML += `<p class="success">✓ Cookies enabled</p>`;
            } else {
                checks.innerHTML += `<p class="error">✗ Cookies disabled</p>`;
            }
            
            // LocalStorage check
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                checks.innerHTML += `<p class="success">✓ LocalStorage accessible</p>`;
            } catch (e) {
                checks.innerHTML += `<p class="error">✗ LocalStorage error: ${e.message}</p>`;
            }
            
            // Check login status
            try {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                checks.innerHTML += `<p>Login status: ${isLoggedIn ? 'Logged in' : 'Not logged in'}</p>`;
                if (isLoggedIn) {
                    const email = localStorage.getItem('userEmail');
                    checks.innerHTML += `<p>User email: ${email || 'Not set'}</p>`;
                }
            } catch (e) {
                checks.innerHTML += `<p class="error">✗ Error checking login: ${e.message}</p>`;
            }
        }
        
        // Library checks
        function checkLibraries() {
            const libTests = document.getElementById('lib-tests');
            
            // Test loading libraries one by one
            function testLib(name, callback) {
                const script = document.createElement('script');
                script.onload = () => {
                    libTests.innerHTML += `<p class="success">✓ ${name} loaded successfully</p>`;
                    if (callback) callback(true);
                };
                script.onerror = () => {
                    libTests.innerHTML += `<p class="error">✗ Failed to load ${name}</p>`;
                    if (callback) callback(false);
                };
                
                // Set the source based on library name
                switch(name) {
                    case 'jsPDF':
                        script.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js";
                        break;
                    case 'html2canvas':
                        script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js";
                        break;
                    case 'emailjs':
                        script.src = "https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js";
                        break;
                }
                
                document.head.appendChild(script);
            }
            
            // Test each library
            libTests.innerHTML = `<p>Testing libraries...</p>`;
            
            testLib('jsPDF', (success) => {
                if (success) {
                    // Check if jsPDF is properly initialized
                    if (typeof window.jspdf !== 'undefined') {
                        libTests.innerHTML += `<p class="success">✓ jsPDF global object available</p>`;
                    } else {
                        libTests.innerHTML += `<p class="error">✗ jsPDF global object not found</p>`;
                    }
                }
                
                testLib('html2canvas', (success) => {
                    if (success) {
                        // Check if html2canvas is properly initialized
                        if (typeof html2canvas !== 'undefined') {
                            libTests.innerHTML += `<p class="success">✓ html2canvas function available</p>`;
                        } else {
                            libTests.innerHTML += `<p class="error">✗ html2canvas function not found</p>`;
                        }
                    }
                    
                    testLib('emailjs', (success) => {
                        if (success) {
                            // Check if emailjs is properly initialized
                            if (typeof emailjs !== 'undefined') {
                                libTests.innerHTML += `<p class="success">✓ emailjs object available</p>`;
                            } else {
                                libTests.innerHTML += `<p class="error">✗ emailjs object not found</p>`;
                            }
                        }
                    });
                });
            });
        }
        
        // LocalStorage test
        function testStorage() {
            const storageTest = document.getElementById('storage-test');
            storageTest.innerHTML = '';
            
            try {
                // Show current localStorage content
                storageTest.innerHTML += `<h3>Current LocalStorage Content:</h3>`;
                if (localStorage.length === 0) {
                    storageTest.innerHTML += `<p>LocalStorage is empty</p>`;
                } else {
                    let html = '<pre>';
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        html += `${key}: ${value}\n`;
                    }
                    html += '</pre>';
                    storageTest.innerHTML += html;
                }
                
                // Test setting and getting a value
                const testValue = 'test-' + Date.now();
                localStorage.setItem('diagnosticTest', testValue);
                const readValue = localStorage.getItem('diagnosticTest');
                
                if (readValue === testValue) {
                    storageTest.innerHTML += `<p class="success">✓ LocalStorage write and read successful</p>`;
                } else {
                    storageTest.innerHTML += `<p class="error">✗ LocalStorage read/write mismatch: wrote "${testValue}", read "${readValue}"</p>`;
                }
                
                // Clean up
                localStorage.removeItem('diagnosticTest');
                
            } catch (e) {
                storageTest.innerHTML += `<p class="error">✗ LocalStorage error: ${e.message}</p>`;
            }
        }
        
        function resetStorage() {
            try {
                localStorage.clear();
                document.getElementById('storage-test').innerHTML = 
                    `<p class="success">LocalStorage cleared successfully</p>`;
            } catch (e) {
                document.getElementById('storage-test').innerHTML = 
                    `<p class="error">Error clearing localStorage: ${e.message}</p>`;
            }
        }
        
        function autoLogin() {
            try {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('userEmail', 'user@example.com');
                document.getElementById('storage-test').innerHTML = 
                    `<p class="success">Auto login set. You are now logged in as user@example.com</p>`;
                runBasicChecks(); // Refresh basic checks
            } catch (e) {
                document.getElementById('storage-test').innerHTML = 
                    `<p class="error">Error setting login: ${e.message}</p>`;
            }
        }
        
        function clearLogin() {
            try {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userEmail');
                document.getElementById('storage-test').innerHTML = 
                    `<p class="success">Login cleared. You are now logged out.</p>`;
                runBasicChecks(); // Refresh basic checks
            } catch (e) {
                document.getElementById('storage-test').innerHTML = 
                    `<p class="error">Error clearing login: ${e.message}</p>`;
            }
        }
        
        // Run checks on page load
        document.addEventListener('DOMContentLoaded', function() {
            runBasicChecks();
            checkLibraries();
            testStorage();
        });
    </script>
</body>
</html>
